{% extends "base.html" %}
{% block content %}
<h2>Staff Dashboard</h2>
<table class="table">
  <thead>
    <tr><th>ID</th><th>Type</th><th>Zone</th><th>State</th><th>Reason</th><th>Action</th></tr>
  </thead>
  <tbody id="rows">
  {% for it in items %}
    <tr data-id="{{ it.shortid }}">
      <td>{{ it.shortid }}</td>
      <td>{{ it.type }}{% if it.color %} ({{ it.color }}){% endif %}</td>
      <td>{{ it.zone }}</td>
      <td class="state {{ it.state|lower }}">{{ it.state }}</td>
      <td class="reason">{{ it.reason }}</td>
      <td>
        {% if it.state != "RECOVERED" %}
          <button class="btn" onclick="resolveItem('{{ it.shortid }}')">Resolve</button>
        {% else %}
          <span>Resolved</span>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
async function resolveItem(id){
  const reason = prompt("Resolution note (optional):", "resolved by staff");
  try{
    const r = await fetch(`/api/items/${id}/resolve`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(reason || "resolved by staff")
    });
    if(!r.ok){ alert("Failed to resolve"); return; }
    // Update row instantly
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if(row){
      const s = row.querySelector(".state");
      s.textContent = "RECOVERED";
      s.className = "state recovered";
      row.querySelector(".reason").textContent = reason || "resolved by staff";
      const btn = row.querySelector("button.btn");
      if(btn){ btn.replaceWith(document.createTextNode("Resolved")); }
    }
  }catch(e){
    alert("Error: " + e);
  }
}
</script>
{% endblock %}
